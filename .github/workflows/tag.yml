# AUTO TAG BASED ON PUSH TO A BRANCH. AUTO RELEASE BASED ON A NON-BETA/TEST TAG.
# REQUIRES PACKAGE.JSON WITH "version" PROPERTY UNDER SEMANTIC VERSIONING. ADDING
# "b" SUFFIX IN THE VERSION IN "version" PROPERTY DEFINES A BETA/TEST TAG.

name: Tag

on:
  push:
    paths:
    - package.json
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    # - uses: actions/checkout@v2
    # - uses: Klemensas/action-autotag@stable
    #   with:
    #     GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
    #     # tag_prefix: "v"
    #     # tag_suffix: "b"
     - uses: actions/checkout@master
     - name: Generating Tag
       id: get-tag
       uses: jaliborc/action-general-autotag@1.0.0
       with:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        source_file: "package.json"
        extraction_regex: "\\s*\"version\"s*:\\s*\"([\\d\\.]+)\""
     - name: Trigger next workflow
       if: "success() && !contains(steps.get-tag.outputs.tagname, 'beta')"
       uses: peter-evans/repository-dispatch@v1
       with:
        token: ${{ secrets.REPO_GHA_PAT }}
        repository: ${{ github.repository }}
        event-type: actions-release
        client-payload: '{"ref": "${{ github.ref }}", "sha": "${{ github.sha }}"}'